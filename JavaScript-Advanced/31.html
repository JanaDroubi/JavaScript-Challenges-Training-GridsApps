<!DOCTYPE html>
<html>
<head><title>Challenge 31: Handle Invalid JSON</title></head>
<body>
<h1>Handle Invalid JSON with try/catch</h1>
<button onclick="testValidJSON()">Test Valid JSON</button>
<button onclick="testInvalidJSON()">Test Invalid JSON</button>
<button onclick="testAPIWithError()">Test API Error</button>
<button onclick="showCode()">Show Code</button>
<div id="result" style="margin:20px 0; padding:15px; background:#f5f5f5;"></div>
<div id="code" style="display:none; background:#f5f5f5; padding:10px;"></div>
<script>
function testValidJSON() {
    const validJSON = '{"name":"John","age":30}';
    
    try {
        const obj = JSON.parse(validJSON);
        document.getElementById('result').innerHTML = `
            <div style="color:green">
                ✅ Valid JSON Parsed Successfully<br>
                Name: ${obj.name}<br>
                Age: ${obj.age}
            </div>
        `;
        console.log('Valid JSON parsed:', obj);
    } catch (error) {
        document.getElementById('result').innerHTML = 
            `<div style="color:red">❌ Error: ${error.message}</div>`;
    }
}

function testInvalidJSON() {
    const invalidJSON = '{name:"John",age:30}'; // Missing quotes around keys
    
    try {
        const obj = JSON.parse(invalidJSON);
        document.getElementById('result').innerHTML = 
            '<div style="color:green">✅ JSON parsed successfully</div>';
    } catch (error) {
        document.getElementById('result').innerHTML = `
            <div style="color:red">
                ❌ JSON Parse Error: ${error.message}<br>
                <strong>Invalid JSON:</strong> ${invalidJSON}<br>
                <strong>Fix:</strong> Add quotes around property names<br>
                <strong>Correct:</strong> {"name":"John","age":30}
            </div>
        `;
        console.error('Parse error:', error);
    }
}

async function testAPIWithError() {
    // Try to fetch from non-existent endpoint
    const badURL = 'https://jsonplaceholder.typicode.com/invalid-endpoint';
    
    try {
        const response = await fetch(badURL);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        document.getElementById('result').innerHTML = 
            '<div style="color:green">✅ API call successful</div>';
        
    } catch (error) {
        document.getElementById('result').innerHTML = `
            <div style="color:red">
                ❌ API Error: ${error.message}<br>
                <strong>URL:</strong> ${badURL}<br>
                <strong>Note:</strong> This endpoint doesn't exist
            </div>
        `;
        console.error('API error:', error);
        
        // Fallback: use local data
        setTimeout(() => {
            document.getElementById('result').innerHTML += `
                <div style="color:orange; margin-top:10px;">
                    ⚠️ Using fallback data instead...
                </div>
            `;
            // Load fallback data here
        }, 1000);
    }
}

function showCode() {
    document.getElementById('code').innerHTML = 
`// Basic try/catch for JSON parsing
function parseJSONSafely(jsonString) {
    try {
        const obj = JSON.parse(jsonString);
        return { success: true, data: obj, error: null };
    } catch (error) {
        return { success: false, data: null, error: error.message };
    }
}

// Example usage
const result1 = parseJSONSafely('{"valid": true}');
console.log(result1); // { success: true, data: {valid: true}, error: null }

const result2 = parseJSONSafely('{invalid json}');
console.log(result2); // { success: false, data: null, error: "Unexpected token i in JSON..." }

// Handling fetch errors
async function fetchWithErrorHandling(url) {
    try {
        const response = await fetch(url);
        
        // Check if response is OK (status 200-299)
        if (!response.ok) {
            throw new Error(\`HTTP error! status: \${response.status}\`);
        }
        
        // Try to parse JSON
        try {
            const data = await response.json();
            return { success: true, data: data, error: null };
        } catch (parseError) {
            throw new Error(\`Invalid JSON in response: \${parseError.message}\`);
        }
        
    } catch (error) {
        console.error('Fetch error:', error);
        
        // Return error information
        return { 
            success: false, 
            data: null, 
            error: error.message,
            url: url
        };
    }
}

// Using the function
fetchWithErrorHandling('https://jsonplaceholder.typicode.com/users')
    .then(result => {
        if (result.success) {
            console.log('Users:', result.data);
        } else {
            console.error('Failed:', result.error);
            // Show user-friendly message
            alert('Failed to load data. Please try again later.');
        }
    });

// Validate JSON before parsing
function isValidJSON(str) {
    try {
        JSON.parse(str);
        return true;
    } catch (error) {
        return false;
    }
}

// Common JSON errors to handle:
// 1. Unexpected token
// 2. Unexpected end of JSON
// 3. Property names must be double-quoted
// 4. Trailing commas
// 5. Single quotes instead of double quotes

// Graceful fallback
async function fetchDataWithFallback(primaryUrl, fallbackData) {
    try {
        const response = await fetch(primaryUrl);
        const data = await response.json();
        return data;
    } catch (error) {
        console.warn('Using fallback data due to error:', error);
        return fallbackData;
    }
}`;
    document.getElementById('code').style.display = 'block';
}
</script>
</body>
</html>